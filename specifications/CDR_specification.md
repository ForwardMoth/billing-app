### [Назад](../README.md)

# Описание Микросервиса cdr-generator-app (Эмулятор коммутатора)

Цель: Генерировать звонки абонентов случайным образом

## Структура Микросервиса 

- cdr-generator-app-service - основная кодовая база микросервиса
- lib-cdr-generator - библиотека микросервиса

## Структура cdr-generator-app-service

- config - конфигурационные файлы
- entity - объектно-реляционные модели
- mapper - мапперы 
- repository - компоненты приложения для взаимодействия с БД
- runner - стартер для запуска после запуска приложения
- service - сервисы:
  - В корне директория хранятся интерфейсы, а их реализации в директории impl
  - notifyBRT - содержит сервис, отвечающий за отправку CDR файла через RabbitMQ в BRT
  - worker - содержит класс для управления фоновыми задачами, которые запускаются стартером (runner)
- util - вспомогательные методы

## Принцип работы 

При запуске приложения запускается класс StartRunner, где создаётся 2 асинхронных задачи:

- Генерация записей CDR 
- Отправка CDR файлов в BRT 

### Генерация записей CDR 

Происходит в постоянном режиме. После каждой итерации для задачи выполняется задержка - 2 секунды.

На каждом шаге генерации выбирается случайное число (от 10 до 100) - количество CDR записей, которые будут добавлены в БД.

Генерация происходит в хронологическом порядке относительно предыдущих итераций, если в БД есть CDR записи. 
Иначе берётся текущая дата и время за вычетом 1 года (начальная дата и время генерации).

Для каждой CDR генерируются 2 случайных абонента, не совпадающих друг с другом, а также
длительность звонка. 

Дата начала звонка = случайно выбранное число секунд (от 3600 до 14400) + дата и время предыдущего звонка 
(начальная дата и время генерации).

Дата окончания звонка = случайно выбранное число секунд (от 60 до 10800) + дата и время начала звонка.

Из полученных данных создаётся CDR и сохраняется в БД.

### Отправка CDR файлов в BRT

Работает в постоянном режиме. Если не найдено ровно 10 записей CDR, то происходит задержка - 1 секунда.

На каждом шаге в БД находится 10 записей CDR, которые составляют CDR файл (список из 10 записей).

CDR файл отправляется в BRT с помощью брокера сообщений Rabbit MQ.
 
